<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>20-normalization.scala</title>
  <link rel="stylesheet" href="../recources/style.css">
</head>
<body>
  <a href="https://github.com/klauso/PLT2012"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>
  <header>
  <nav>
    <ul>    
        <li><a href="10-gc.html">10-gc.scala</a></li>
        <li><a href="11-syntacticvsmeta.html">11-syntacticvsmeta.scala</a></li>
        <li><a href="12-churchencoding.html">12-churchencoding.scala</a></li>
        <li><a href="13-cpstransformation.html">13-cpstransformation.scala</a></li>
        <li><a href="14-cpstransformation2.html">14-cpstransformation2.scala</a></li>
        <li><a href="16-firstclasscontinuations.html">16-firstclasscontinuations.scala</a></li>
        <li><a href="17-defunctionalization.html">17-defunctionalization.scala</a></li>
        <li><a href="18-abstractmachines.html">18-abstractmachines.scala</a></li>
        <li><a href="2-ae.html">2-ae.scala</a></li>
        <li><a href="20-normalization.html">20-normalization.scala</a></li>
        <li><a href="21-OO.html">21-OO.scala</a></li>
        <li><a href="26-OO-typed.html">26-OO-typed.scala</a></li>
        <li><a href="3-wae.html">3-wae.scala</a></li>
        <li><a href="4-f1wae.html">4-f1wae.scala</a></li>
        <li><a href="5-fae.html">5-fae.scala</a></li>
        <li><a href="6-lcfae.html">6-lcfae.scala</a></li>
        <li><a href="8-rcfae.html">8-rcfae.scala</a></li>
        <li><a href="9-bcfae.html">9-bcfae.scala</a></li>
    </ul>
  </nav>
  </header>
  <article id="documentation">
    <section id='section-1'>
      <div class="docs"><p>Programming Languages and Types, Winter term 2012/13</p>

<p>Lecture on the structure of syntax and semantics;
and their connection by evaluation (in one direction)
and reification (in the other direction).</p>

<p>Substitute lecture by Tillmann Rendel</p></div>
      <div class="code"><code class='highlight'><pre>  </pre></code></div>
    </section>
    <section id='section-INTRODUCTION'>
      <div class="docs"><h1>INTRODUCTION</h1>

<p>The motivating example for this lecture is the following
FAE program:</p>

<pre><code>App(Fun(&lsquo;y, Fun('x, Add('x, Add('y, 1)))), 2)
</code></pre>

<p>Evaluating this program yields &hellip;</p>

<p>&hellip; in the substitution-based interpreter:</p>

<pre><code>Fun('x, Add('x, Add(2, 1)))
</code></pre>

<p>&hellip; in the environment-based interpreter:</p>

<pre><code>FunV('x, Add('x, Add('y, 1)), 'y &ndash;&gt; 2)
</code></pre>

<p>Neither of these interpreters computes 2 + 1 = 3.
This computation is left for later, when the function
is actually called.</p>

<p>There are (at least) two reasons for performing
some computations in a function body earlier:</p>

<p>(1) It can save work: If the function is called
     often, we should do as much work as possible
     before constructing the function value.</p>

<p>(2) It can help us to recognize equivalent programs.</p>

<p>To understand the second point, we have to understand
that there are many programs that describe the same
function. For example:</p>

<pre><code>Abs('x, Add('x, Add(1, 1)))
Abs('x, Add(1, Add('x, 1)))
Abs('x, Add('x, 2))
</code></pre>

<p>All of these programs describe the function that adds
two to its argument. We say that these programs are
equivalent. Among this set of equivalent programs, the
last program is in a normal form, because it does not
contain any subcomputations that we could perform right
now. One goal of today&rsquo;s lecture is to transform a program
into its normal form.</p>

<p>I also want to use this lecture to introduce my idea of how
an interpreter should be structured: I believe that one
should carefully distinguish between the <em>syntactical</em> and
the <em>semantical</em> structure of a language.</p>

<pre><code>        Syntax                           Semantics    
</code></pre>

<hr>

<p>Objects:    Terms / Expressions / Programs   Values</p>

<h2>Structure:  substitution, &hellip;                application, &hellip;</h2>

<p>Evaluation is a mapping from Syntax to Semantics:</p>

<pre><code>Syntax    &mdash;-evaluation&mdash;&gt;  Semantics
</code></pre>

<h1>SYNTAX</h1>

<p>We start with the syntax of FAE as presented in earlier
lectures. I put everything into a Syntax object to distinguish
syntax and semantics more clearly from each other.</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">object</span> <span class="nc">Syntax</span> <span class="o">{</span>
  <span class="k">sealed</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">Exp</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Exp</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Id</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Exp</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Add</span><span class="o">(</span><span class="n">lhs</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">,</span> <span class="n">rhs</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Exp</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Fun</span><span class="o">(</span><span class="n">param</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">,</span> <span class="n">body</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Exp</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">App</span> <span class="o">(</span><span class="n">funExpr</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">,</span> <span class="n">argExpr</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Exp</span>

  <span class="k">implicit</span> <span class="k">def</span> <span class="n">num2exp</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n</span><span class="o">)</span>
  <span class="k">implicit</span> <span class="k">def</span> <span class="n">id2exp</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Id</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">wth</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">,</span> <span class="n">xdef</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">,</span> <span class="n">body</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Exp</span> <span class="o">=</span> <span class="nc">App</span><span class="o">(</span><span class="nc">Fun</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">body</span><span class="o">),</span> <span class="n">xdef</span><span class="o">)</span>
<span class="o">}</span></pre></code></div>
    </section>
    <section id='section-Examples'>
      <div class="docs"><h1>Examples</h1>

<p>As example terms, we use the motivating example from above, with
two different ways to apply the function to 2. Either directly,
or indirectly via an application function written in FAE.</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">object</span> <span class="nc">Example</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">Syntax._</span>

  <span class="k">val</span> <span class="nc">TERM</span> <span class="k">=</span> <span class="nc">Fun</span><span class="o">(</span><span class="-Symbol">&#39;y</span><span class="o">,</span> <span class="nc">Fun</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="nc">Add</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="nc">Add</span><span class="o">(</span><span class="-Symbol">&#39;y</span><span class="o">,</span> <span class="mi">1</span><span class="o">))))</span>
  <span class="k">val</span> <span class="nc">APPLY</span> <span class="k">=</span> <span class="nc">Fun</span><span class="o">(</span><span class="-Symbol">&#39;f</span><span class="o">,</span> <span class="nc">Fun</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="nc">App</span><span class="o">(</span><span class="-Symbol">&#39;f</span><span class="o">,</span> <span class="-Symbol">&#39;x</span><span class="o">)))</span>

  <span class="k">val</span> <span class="nc">TEST1</span> <span class="k">=</span> <span class="nc">App</span><span class="o">(</span><span class="nc">TERM</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span>
  <span class="k">val</span> <span class="nc">TEST2</span> <span class="k">=</span> <span class="nc">App</span><span class="o">(</span><span class="nc">App</span><span class="o">(</span><span class="nc">APPLY</span><span class="o">,</span> <span class="nc">TERM</span><span class="o">),</span> <span class="mi">2</span><span class="o">)</span>
<span class="o">}</span></pre></code></div>
    </section>
    <section id='section-SEMANTICS'>
      <div class="docs"><h1>SEMANTICS</h1>

<p>We now define the semantic structure of FAE.
In this first version of the semantics, we only include
features that we need for evaluation.</p>

<p>Notes:</p>

<p>(1) The semantics is <em>only</em> about values, and not about
     expressions at all. We make this explicit by not even
     importing the members of the Syntax object above.</p>

<p>(2) The interpreter is meta-circular: FAE numbers are
     represented as Scala integers, and FAE functions
     are represented as Scala functions.</p>

<p>(3) We introduce a name for the function type Env =&gt; Value.
     This will be the return type of the eval function. One
     way to understand the name &ldquo;domain&rdquo; is: From all the
     things in the (mathematical) world, we select a subset
     of things we want to talk about in our language FAE, and
     this subset of things of interest forms the domain of our
     language.
     (Not to be confused with the domain of a function, which
     is the subset of all the things in the world a function
     can be applied to).</p>

<p>(4) We have a function for each syntactic construct of FAE.
     These functions operate on things in the Domain. They
     perform all the work that is necessary to implement the
     syntactic construct.</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">object</span> <span class="nc">Semantics</span> <span class="o">{</span>
  <span class="k">type</span> <span class="kt">Domain</span> <span class="o">=</span> <span class="nc">Env</span> <span class="k">=&gt;</span> <span class="nc">Value</span>

  <span class="k">type</span> <span class="kt">Env</span> <span class="o">=</span> <span class="nc">Map</span><span class="o">[</span><span class="kt">Symbol</span>, <span class="kt">Value</span><span class="o">]</span>

  <span class="k">abstract</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">Value</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Fun</span><span class="o">(</span><span class="n">f</span> <span class="k">:</span> <span class="kt">Value</span> <span class="o">=&gt;</span> <span class="nc">Value</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Value</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n</span> <span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Value</span>

  <span class="k">def</span> <span class="n">num</span><span class="o">(</span><span class="n">n</span> <span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Domain</span> <span class="o">=</span>
    <span class="o">(</span><span class="n">env</span> <span class="k">:</span> <span class="kt">Env</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">id</span><span class="o">(</span><span class="n">x</span> <span class="k">:</span> <span class="kt">Symbol</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Domain</span> <span class="o">=</span>
    <span class="o">(</span><span class="n">env</span> <span class="k">:</span> <span class="kt">Env</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">env</span><span class="o">(</span><span class="n">x</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">add</span><span class="o">(</span><span class="n">lhs</span> <span class="k">:</span> <span class="kt">Domain</span><span class="o">,</span> <span class="n">rhs</span> <span class="k">:</span> <span class="kt">Domain</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Domain</span> <span class="o">=</span>
    <span class="o">(</span><span class="n">env</span> <span class="k">:</span> <span class="kt">Env</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">lhs</span><span class="o">(</span><span class="n">env</span><span class="o">),</span> <span class="n">rhs</span><span class="o">(</span><span class="n">env</span><span class="o">))</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="o">(</span><span class="nc">Num</span><span class="o">(</span><span class="n">n1</span><span class="o">),</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n2</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="o">)</span>
      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;not happy&quot;</span><span class="o">)</span>
    <span class="o">}</span>

  <span class="k">def</span> <span class="n">app</span><span class="o">(</span><span class="n">fun</span> <span class="k">:</span> <span class="kt">Domain</span><span class="o">,</span> <span class="n">arg</span> <span class="k">:</span> <span class="kt">Domain</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Domain</span> <span class="o">=</span>
    <span class="o">(</span><span class="n">env</span> <span class="k">:</span> <span class="kt">Env</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">fun</span><span class="o">(</span><span class="n">env</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Fun</span><span class="o">(</span><span class="n">f</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">f</span><span class="o">(</span><span class="n">arg</span><span class="o">(</span><span class="n">env</span><span class="o">))</span>
      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;not happy&quot;</span><span class="o">)</span>
    <span class="o">}</span>
 
  <span class="k">def</span> <span class="n">fun</span><span class="o">(</span><span class="n">x</span> <span class="k">:</span> <span class="kt">Symbol</span><span class="o">,</span> <span class="n">body</span> <span class="k">:</span> <span class="kt">Domain</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Domain</span> <span class="o">=</span>
    <span class="o">(</span><span class="n">env</span> <span class="k">:</span> <span class="kt">Env</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Fun</span><span class="o">(</span><span class="n">arg</span> <span class="k">=&gt;</span> <span class="n">body</span><span class="o">(</span><span class="n">env</span> <span class="o">+</span> <span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">arg</span><span class="o">)))</span>
<span class="o">}</span></pre></code></div>
    </section>
    <section id='section-EVALUATION'>
      <div class="docs"><h1>EVALUATION</h1>

<p>Evaluation maps syntactic structure to semantic structure.
All the hard work is done in the semantics above, so evaluation
is almost boring.</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">object</span> <span class="nc">Evaluation</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="n">e</span> <span class="k">:</span> <span class="kt">Syntax.Exp</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Semantics.Domain</span> <span class="o">=</span>
    <span class="n">e</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Syntax</span><span class="o">.</span><span class="nc">Num</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Semantics</span><span class="o">.</span><span class="n">num</span><span class="o">(</span><span class="n">n</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">Syntax</span><span class="o">.</span><span class="nc">Id</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Semantics</span><span class="o">.</span><span class="n">id</span><span class="o">(</span><span class="n">x</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">Syntax</span><span class="o">.</span><span class="nc">Add</span><span class="o">(</span><span class="n">e1</span><span class="o">,</span> <span class="n">e2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Semantics</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">eval</span><span class="o">(</span><span class="n">e1</span><span class="o">),</span> <span class="n">eval</span><span class="o">(</span><span class="n">e2</span><span class="o">))</span>
      <span class="k">case</span> <span class="nc">Syntax</span><span class="o">.</span><span class="nc">Fun</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Semantics</span><span class="o">.</span><span class="n">fun</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">eval</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
      <span class="k">case</span> <span class="nc">Syntax</span><span class="o">.</span><span class="nc">App</span><span class="o">(</span><span class="n">e1</span><span class="o">,</span> <span class="n">e2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Semantics</span><span class="o">.</span><span class="n">app</span><span class="o">(</span><span class="n">eval</span><span class="o">(</span><span class="n">e1</span><span class="o">),</span> <span class="n">eval</span><span class="o">(</span><span class="n">e2</span><span class="o">))</span>
    <span class="o">}</span>
<span class="o">}</span></pre></code></div>
    </section>
    <section id='section-REIFICATION'>
      <div class="docs"><h1>REIFICATION</h1>

<p>Reification is the inverse of evaluation:</p>

<pre><code>       &mdash;-evaluation&mdash;&gt;
Syntax                   Semantics
       &lt;&mdash;reification&mdash;
</code></pre>

<p>Reification comes from latin &ldquo;res&rdquo; = thing. It means to
represent something abstract as something more concrete.
In our case, the abstract is a value in the domain,
and the concrete is an FAE expression.</p>

<p>The first step is to extend the semantic structure with
support for <em>symbolic computation</em>. All changed parts are
marked with comments.</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">object</span> <span class="nc">Semantics2</span> <span class="o">{</span>
  <span class="k">type</span> <span class="kt">Domain</span> <span class="o">=</span> <span class="nc">Env</span> <span class="k">=&gt;</span> <span class="nc">Value</span>

  <span class="k">type</span> <span class="kt">Env</span> <span class="o">=</span> <span class="nc">Map</span><span class="o">[</span><span class="kt">Symbol</span>, <span class="kt">Value</span><span class="o">]</span>

  <span class="k">abstract</span> <span class="k">class</span> <span class="nc">Value</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Fun</span><span class="o">(</span><span class="n">f</span> <span class="k">:</span> <span class="kt">Value</span> <span class="o">=&gt;</span> <span class="nc">Value</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Value</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n</span> <span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Value</span>

  <span class="c1">// Three new case classes for symbolic values:</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Id</span><span class="o">(</span><span class="n">x</span> <span class="k">:</span> <span class="kt">Symbol</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Value</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Add</span><span class="o">(</span><span class="n">lhs</span> <span class="k">:</span> <span class="kt">Value</span><span class="o">,</span> <span class="n">rhs</span> <span class="k">:</span> <span class="kt">Value</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Value</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">App</span><span class="o">(</span><span class="n">fun</span> <span class="k">:</span> <span class="kt">Value</span><span class="o">,</span> <span class="n">arg</span> <span class="k">:</span> <span class="kt">Value</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Value</span>

  <span class="c1">// A new helper function to decide whether a value</span>
  <span class="c1">// could mean a number</span>
  <span class="k">def</span> <span class="n">canBeNumber</span><span class="o">(</span><span class="n">v</span> <span class="k">:</span> <span class="kt">Value</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="n">v</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Fun</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">false</span>
    <span class="k">case</span> <span class="nc">Num</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">true</span>
    <span class="k">case</span> <span class="nc">Id</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">true</span>
    <span class="k">case</span> <span class="nc">Add</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">true</span>
    <span class="k">case</span> <span class="nc">App</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">true</span>
  <span class="o">}</span>

  <span class="c1">// A new helper function to decide whether a value</span>
  <span class="c1">// could mean a function</span>
  <span class="k">def</span> <span class="n">canBeFunction</span><span class="o">(</span><span class="n">v</span> <span class="k">:</span> <span class="kt">Value</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="n">v</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Fun</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">true</span>
    <span class="k">case</span> <span class="nc">Num</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">false</span>
    <span class="k">case</span> <span class="nc">Id</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">true</span>
    <span class="k">case</span> <span class="nc">Add</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">false</span>
    <span class="k">case</span> <span class="nc">App</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">true</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">num</span><span class="o">(</span><span class="n">n</span> <span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Domain</span> <span class="o">=</span>
    <span class="o">(</span><span class="n">env</span> <span class="k">:</span> <span class="kt">Env</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">id</span><span class="o">(</span><span class="n">x</span> <span class="k">:</span> <span class="kt">Symbol</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Domain</span> <span class="o">=</span>
    <span class="o">(</span><span class="n">env</span> <span class="k">:</span> <span class="kt">Env</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">env</span><span class="o">(</span><span class="n">x</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">add</span><span class="o">(</span><span class="n">lhs</span> <span class="k">:</span> <span class="kt">Domain</span><span class="o">,</span> <span class="n">rhs</span> <span class="k">:</span> <span class="kt">Domain</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Domain</span> <span class="o">=</span>
    <span class="o">(</span><span class="n">env</span> <span class="k">:</span> <span class="kt">Env</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">lhs</span><span class="o">(</span><span class="n">env</span><span class="o">),</span> <span class="n">rhs</span><span class="o">(</span><span class="n">env</span><span class="o">))</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="o">(</span><span class="nc">Num</span><span class="o">(</span><span class="n">n1</span><span class="o">),</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n2</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="o">)</span>
      <span class="c1">// new case for symbolic addition:</span>
      <span class="k">case</span> <span class="o">(</span><span class="n">val1</span><span class="o">,</span> <span class="n">val2</span><span class="o">)</span> <span class="k">if</span> <span class="n">canBeNumber</span><span class="o">(</span><span class="n">val1</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">canBeNumber</span><span class="o">(</span><span class="n">val2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Add</span><span class="o">(</span><span class="n">val1</span><span class="o">,</span> <span class="n">val2</span><span class="o">)</span>
      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;not happy&quot;</span><span class="o">)</span>
    <span class="o">}</span>

  <span class="k">def</span> <span class="n">app</span><span class="o">(</span><span class="n">fun</span> <span class="k">:</span> <span class="kt">Domain</span><span class="o">,</span> <span class="n">arg</span> <span class="k">:</span> <span class="kt">Domain</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Domain</span> <span class="o">=</span>
    <span class="o">(</span><span class="n">env</span> <span class="k">:</span> <span class="kt">Env</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">fun</span><span class="o">(</span><span class="n">env</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Fun</span><span class="o">(</span><span class="n">f</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">f</span><span class="o">(</span><span class="n">arg</span><span class="o">(</span><span class="n">env</span><span class="o">))</span>
      <span class="c1">// new case for symbolic application:</span>
      <span class="k">case</span> <span class="o">(</span><span class="n">funVal</span><span class="o">)</span> <span class="k">if</span> <span class="n">canBeFunction</span><span class="o">(</span><span class="n">funVal</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">App</span><span class="o">(</span><span class="n">funVal</span><span class="o">,</span> <span class="n">arg</span><span class="o">(</span><span class="n">env</span><span class="o">))</span>
      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;not happy&quot;</span><span class="o">)</span>
    <span class="o">}</span>
 
  <span class="k">def</span> <span class="n">fun</span><span class="o">(</span><span class="n">x</span> <span class="k">:</span> <span class="kt">Symbol</span><span class="o">,</span> <span class="n">body</span> <span class="k">:</span> <span class="kt">Domain</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Domain</span> <span class="o">=</span>
    <span class="o">(</span><span class="n">env</span> <span class="k">:</span> <span class="kt">Env</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Fun</span><span class="o">(</span><span class="n">arg</span> <span class="k">=&gt;</span> <span class="n">body</span><span class="o">(</span><span class="n">env</span> <span class="o">+</span> <span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">arg</span><span class="o">)))</span>
<span class="o">}</span></pre></code></div>
    </section>
    <section id='section-7'>
      <div class="docs"><p>This enhanced semantic structure is still suitable for
evaluation. We don&rsquo;t have to change anything at all in
the evaluation function:</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">object</span> <span class="nc">Evaluation2</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="n">e</span> <span class="k">:</span> <span class="kt">Syntax.Exp</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Semantics2.Domain</span> <span class="o">=</span>
    <span class="n">e</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Syntax</span><span class="o">.</span><span class="nc">Num</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Semantics2</span><span class="o">.</span><span class="n">num</span><span class="o">(</span><span class="n">n</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">Syntax</span><span class="o">.</span><span class="nc">Id</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Semantics2</span><span class="o">.</span><span class="n">id</span><span class="o">(</span><span class="n">x</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">Syntax</span><span class="o">.</span><span class="nc">Add</span><span class="o">(</span><span class="n">e1</span><span class="o">,</span> <span class="n">e2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Semantics2</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">eval</span><span class="o">(</span><span class="n">e1</span><span class="o">),</span> <span class="n">eval</span><span class="o">(</span><span class="n">e2</span><span class="o">))</span>
      <span class="k">case</span> <span class="nc">Syntax</span><span class="o">.</span><span class="nc">Fun</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Semantics2</span><span class="o">.</span><span class="n">fun</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">eval</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
      <span class="k">case</span> <span class="nc">Syntax</span><span class="o">.</span><span class="nc">App</span><span class="o">(</span><span class="n">e1</span><span class="o">,</span> <span class="n">e2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Semantics2</span><span class="o">.</span><span class="n">app</span><span class="o">(</span><span class="n">eval</span><span class="o">(</span><span class="n">e1</span><span class="o">),</span> <span class="n">eval</span><span class="o">(</span><span class="n">e2</span><span class="o">))</span>
    <span class="o">}</span>
<span class="o">}</span></pre></code></div>
    </section>
    <section id='section-8'>
      <div class="docs"><p>And the enhanced semantics structure with its support
for symbolic computation is also suitable for reification.</p>

<p>Notes:</p>

<p>(1) We use a cheap trick for generating fresh identifiers.
     Don&rsquo;t do that at home.</p>

<p>(2) The first four cases of reify are straight-forward.</p>

<p>(3) The case for functions is all-important.</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">object</span> <span class="nc">Reification</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">i</span> <span class="k">=</span> <span class="mi">0</span>

  <span class="k">def</span> <span class="n">fresh</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Symbol</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nc">Symbol</span><span class="o">(</span><span class="s">&quot;x&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">reify</span><span class="o">(</span><span class="n">v</span> <span class="k">:</span> <span class="kt">Semantics2.Value</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Syntax.Exp</span> <span class="o">=</span> <span class="n">v</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Semantics2</span><span class="o">.</span><span class="nc">Id</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Syntax</span><span class="o">.</span><span class="nc">Id</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">Semantics2</span><span class="o">.</span><span class="nc">Num</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Syntax</span><span class="o">.</span><span class="nc">Num</span><span class="o">(</span><span class="n">n</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">Semantics2</span><span class="o">.</span><span class="nc">Add</span><span class="o">(</span><span class="n">lhs</span><span class="o">,</span> <span class="n">rhs</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Syntax</span><span class="o">.</span><span class="nc">Add</span><span class="o">(</span><span class="n">reify</span><span class="o">(</span><span class="n">lhs</span><span class="o">),</span> <span class="n">reify</span><span class="o">(</span><span class="n">rhs</span><span class="o">))</span>
    <span class="k">case</span> <span class="nc">Semantics2</span><span class="o">.</span><span class="nc">App</span><span class="o">(</span><span class="n">fun</span><span class="o">,</span> <span class="n">arg</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Syntax</span><span class="o">.</span><span class="nc">App</span><span class="o">(</span><span class="n">reify</span><span class="o">(</span><span class="n">fun</span><span class="o">),</span> <span class="n">reify</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span>

    <span class="k">case</span> <span class="nc">Semantics2</span><span class="o">.</span><span class="nc">Fun</span><span class="o">(</span><span class="n">f</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">x</span> <span class="k">=</span> <span class="n">fresh</span><span class="o">()</span>
      <span class="nc">Syntax</span><span class="o">.</span><span class="nc">Fun</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">reify</span><span class="o">(</span><span class="n">f</span><span class="o">(</span><span class="nc">Semantics2</span><span class="o">.</span><span class="nc">Id</span><span class="o">(</span><span class="n">x</span><span class="o">))))</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></pre></code></div>
    </section>
    <section id='section-9'>
      <div class="docs"><p>Going from syntax to semantics and back is normalization.</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">def</span> <span class="n">norm</span><span class="o">(</span><span class="n">e</span> <span class="k">:</span> <span class="kt">Syntax.Exp</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Syntax.Exp</span> <span class="o">=</span>
  <span class="nc">Reification</span><span class="o">.</span><span class="n">reify</span><span class="o">(</span><span class="nc">Evaluation2</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">e</span><span class="o">)(</span><span class="nc">Map</span><span class="o">()))</span></pre></code></div>
    </section>
    <section id='section-10'>
      <div class="docs"><p>Some tests.</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">val</span> <span class="n">test1</span> <span class="k">=</span> <span class="n">norm</span><span class="o">(</span><span class="nc">Example</span><span class="o">.</span><span class="nc">TEST1</span><span class="o">)</span>
<span class="k">val</span> <span class="n">test2</span> <span class="k">=</span> <span class="n">norm</span><span class="o">(</span><span class="nc">Example</span><span class="o">.</span><span class="nc">TEST2</span><span class="o">)</span></pre></code></div>
    </section>
    <section id='section-SUMMARY'>
      <div class="docs"><h1>SUMMARY</h1>

<p>We implemented an interpreter where syntax and semantics
is strictly separated. Most of the hard work is in the
semantics, in functions like app and add. Evaluation is
very simple: We just map the syntactic structure to the
semantic structure. We also defined reification, the
inverse of evaluation. This required two tricks: (1) We
enhanced the semantics with support for symbolic computation,
effectively adding a copy of all Exp constructors to the
Value type. (2) In the case for the reifications of
functions, we apply the function to a fresh identifier.</p>
</div>
      <div class="code"><code class='highlight'><pre></pre></code></div>
    </section>
  </article>
</body>

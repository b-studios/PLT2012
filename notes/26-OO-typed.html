<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>26-OO-typed.scala</title>
  <link rel="stylesheet" href="../recources/style.css">
</head>
<body>
  <a href="https://github.com/klauso/PLT2012"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>
  <header>
  <nav>
    <ul>    
        <li><a href="10-gc.html">10-gc.scala</a></li>
        <li><a href="11-syntacticvsmeta.html">11-syntacticvsmeta.scala</a></li>
        <li><a href="12-churchencoding.html">12-churchencoding.scala</a></li>
        <li><a href="13-cpstransformation.html">13-cpstransformation.scala</a></li>
        <li><a href="14-cpstransformation2.html">14-cpstransformation2.scala</a></li>
        <li><a href="16-firstclasscontinuations.html">16-firstclasscontinuations.scala</a></li>
        <li><a href="17-defunctionalization.html">17-defunctionalization.scala</a></li>
        <li><a href="18-abstractmachines.html">18-abstractmachines.scala</a></li>
        <li><a href="2-ae.html">2-ae.scala</a></li>
        <li><a href="20-normalization.html">20-normalization.scala</a></li>
        <li><a href="21-OO.html">21-OO.scala</a></li>
        <li><a href="26-OO-typed.html">26-OO-typed.scala</a></li>
        <li><a href="3-wae.html">3-wae.scala</a></li>
        <li><a href="4-f1wae.html">4-f1wae.scala</a></li>
        <li><a href="5-fae.html">5-fae.scala</a></li>
        <li><a href="6-lcfae.html">6-lcfae.scala</a></li>
        <li><a href="8-rcfae.html">8-rcfae.scala</a></li>
        <li><a href="9-bcfae.html">9-bcfae.scala</a></li>
    </ul>
  </nav>
  </header>
  <article id="documentation">
    <section id='section-1'>
      <div class="docs"><p>This is the statically typed version of the mini OO language we designed in class on December 19, 2011 (see 19-OO.scala)
The type system was discussed in class on January 24, 2012.</p>

<p>Comments and explanations will be added later. For now, please experiment with the type checker.</p>
</div>
      <div class="code"><code class='highlight'><pre><span class="k">sealed</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">Exp</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">New</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">,</span> <span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Exp</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Exp</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">GetField</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">,</span> <span class="n">fieldName</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Exp</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">MethodCall</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">,</span> <span class="n">methodName</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">,</span> <span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Exp</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Exp</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Id</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Exp</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">MethodDecl</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">Symbol</span>,<span class="kt">Symbol</span><span class="o">)],</span> <span class="n">body</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">,</span> <span class="n">retType</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Class</span><span class="o">(</span> <span class="c1">// name: Symbol,</span>
                 <span class="n">superClass</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">,</span> 
                 <span class="n">fields</span><span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">Symbol</span>,<span class="kt">Symbol</span><span class="o">)],</span>  <span class="c1">// first component: field name, second component: field type</span>
                 <span class="n">methods</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Symbol</span>, <span class="kt">MethodDecl</span><span class="o">])</span>
                
<span class="k">def</span> <span class="n">allFields</span><span class="o">(</span><span class="n">classes</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Symbol</span>,<span class="kt">Class</span><span class="o">],</span> <span class="n">className</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">)</span> <span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">Symbol</span>,<span class="kt">Symbol</span><span class="o">)]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="n">className</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="-Symbol">&#39;Object</span> <span class="k">=&gt;</span> <span class="nc">List</span><span class="o">.</span><span class="n">empty</span>
    <span class="k">case</span> <span class="n">cn</span> <span class="k">=&gt;</span> <span class="n">classes</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">cn</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">cl</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">allFields</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">superClass</span><span class="o">)</span> <span class="o">++</span> <span class="n">cl</span><span class="o">.</span><span class="n">fields</span>
        <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;class not found: &quot;</span><span class="o">+</span><span class="n">cn</span><span class="o">)</span>        
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// returns list of (type, argname) pairs, body, and return type</span>
<span class="k">def</span> <span class="n">lookupMethod</span><span class="o">(</span><span class="n">classes</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Symbol</span>,<span class="kt">Class</span><span class="o">],</span> <span class="n">className</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">,</span> <span class="n">methodName</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">MethodDecl</span><span class="o">]</span>  <span class="k">=</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">className</span> <span class="o">==</span> <span class="-Symbol">&#39;Object</span><span class="o">)</span> <span class="nc">None</span> <span class="k">else</span> 
      <span class="n">classes</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">className</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">cl</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">methods</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">methodName</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">mthd</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">mthd</span><span class="o">)</span>
          <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="n">lookupMethod</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">superClass</span><span class="o">,</span> <span class="n">methodName</span><span class="o">)</span> 
        <span class="o">}</span>
        <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;class not found: &quot;</span><span class="o">+</span><span class="n">className</span><span class="o">)</span> 
      <span class="o">}</span>    
<span class="o">}</span>

<span class="k">def</span> <span class="n">subst</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">,</span> <span class="n">substitutions</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Symbol</span>, <span class="kt">Exp</span><span class="o">])</span> <span class="k">:</span> <span class="kt">Exp</span> <span class="o">=</span> <span class="n">e</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Id</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">substitutions</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span>
  <span class="k">case</span> <span class="nc">New</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">New</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">subst</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">substitutions</span><span class="o">)))</span>
  <span class="k">case</span> <span class="nc">GetField</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">fieldName</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">GetField</span><span class="o">(</span><span class="n">subst</span><span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">substitutions</span><span class="o">),</span> <span class="n">fieldName</span><span class="o">)</span>
  <span class="k">case</span> <span class="nc">MethodCall</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">methodName</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="k">=&gt;</span> 
    <span class="nc">MethodCall</span><span class="o">(</span><span class="n">subst</span><span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">substitutions</span><span class="o">),</span> <span class="n">methodName</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">subst</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">substitutions</span><span class="o">)))</span>
<span class="o">}</span>
                  
<span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="n">classes</span> <span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Symbol</span>,<span class="kt">Class</span><span class="o">],</span> <span class="n">exp</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Exp</span>  <span class="o">=</span> <span class="n">exp</span>  <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Id</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;unknown identifier: &quot;</span><span class="o">+</span><span class="n">x</span><span class="o">)</span>
  <span class="k">case</span> <span class="nc">New</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="k">=&gt;</span> 
      <span class="nc">New</span><span class="o">(</span><span class="n">name</span><span class="o">,</span>  <span class="n">args</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">eval</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span><span class="k">_</span><span class="o">)))</span>
  <span class="k">case</span> <span class="nc">GetField</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">fieldName</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">eval</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span><span class="n">e</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">New</span><span class="o">(</span><span class="n">cn</span><span class="o">,</span> <span class="n">fieldValues</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span> <span class="o">++</span> <span class="n">allFields</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span> <span class="n">cn</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_1</span><span class="o">).</span><span class="n">zip</span><span class="o">(</span><span class="n">fieldValues</span><span class="o">))(</span><span class="n">fieldName</span><span class="o">)</span>
    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;Unevaluated expression&quot;</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="k">case</span> <span class="nc">MethodCall</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">methodName</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">eval</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span><span class="n">e</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">newthis</span><span class="nd">@New</span><span class="o">(</span><span class="n">cn</span><span class="o">,</span> <span class="n">fields</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="n">lookupMethod</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span> <span class="n">cn</span><span class="o">,</span> <span class="n">methodName</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">method</span><span class="o">)</span> <span class="k">=&gt;</span>  
           <span class="n">eval</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span>
             <span class="n">subst</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="n">body</span><span class="o">,</span>  <span class="nc">Map</span><span class="o">(</span><span class="-Symbol">&#39;this</span> <span class="o">-&gt;</span> <span class="n">newthis</span><span class="o">)</span>  <span class="o">++</span> <span class="n">method</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_1</span><span class="o">).</span><span class="n">zip</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">eval</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span><span class="k">_</span><span class="o">)))))</span>
        <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;Method not found: &quot;</span><span class="o">+</span><span class="n">methodName</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;Unevaluated expression&quot;</span><span class="o">)</span>
  <span class="o">}</span> 
<span class="o">}</span>   

<span class="k">def</span> <span class="n">subtype</span><span class="o">(</span><span class="n">classes</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Symbol</span>, <span class="kt">Class</span><span class="o">],</span> <span class="n">c1</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">,</span> <span class="n">c2</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="o">(</span><span class="n">c1</span> <span class="o">==</span> <span class="n">c2</span><span class="o">)</span> <span class="kc">true</span> <span class="k">else</span> 
    <span class="k">if</span> <span class="o">(</span><span class="n">c1</span> <span class="o">==</span> <span class="-Symbol">&#39;Object</span><span class="o">)</span> <span class="kc">false</span> <span class="k">else</span> 
       <span class="n">subtype</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span> <span class="n">classes</span><span class="o">(</span><span class="n">c1</span><span class="o">).</span><span class="n">superClass</span><span class="o">,</span> <span class="n">c2</span><span class="o">)</span>

<span class="k">def</span> <span class="n">typecheck</span><span class="o">(</span><span class="n">classes</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Symbol</span>, <span class="kt">Class</span><span class="o">],</span> <span class="n">env</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Symbol</span>, <span class="kt">Symbol</span><span class="o">],</span> <span class="n">exp</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Symbol</span> <span class="o">=</span> <span class="n">exp</span> <span class="k">match</span> 
<span class="o">{</span>
  <span class="k">case</span> <span class="nc">Id</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">c</span>
    <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;unknown identifier: &quot;</span><span class="o">+</span><span class="n">x</span> <span class="o">+</span> <span class="s">&quot; in env: &quot;</span><span class="o">+</span><span class="n">env</span><span class="o">)</span>
  <span class="o">}</span>    
  <span class="k">case</span> <span class="nc">New</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">classes</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">cl</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">argtypes</span> <span class="k">=</span> <span class="n">args</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">typecheck</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span><span class="n">env</span><span class="o">,</span><span class="k">_</span><span class="o">))</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">length</span> <span class="o">!=</span> <span class="n">argtypes</span><span class="o">.</span><span class="n">length</span><span class="o">)</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;wrong number of arguments&quot;</span><span class="o">)</span> 
      <span class="n">argtypes</span><span class="o">.</span><span class="n">zip</span><span class="o">(</span><span class="n">allFields</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span> <span class="n">name</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_2</span><span class="o">)).</span>
        <span class="n">foreach</span><span class="o">(</span> <span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="o">(</span><span class="kt">Symbol</span><span class="o">,</span><span class="kt">Symbol</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="o">(!</span> <span class="n">subtype</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="n">_1</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="n">_2</span><span class="o">))</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;Actual arg type &quot;</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">_1</span><span class="o">+</span><span class="s">&quot; is not a subtype of formal arg type &quot;</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">_2</span><span class="o">))</span>
      <span class="n">name</span>
    <span class="o">}</span>    
    <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;unknown class: &quot;</span><span class="o">+</span><span class="n">name</span><span class="o">)</span>
  <span class="o">}</span>    
  <span class="k">case</span> <span class="nc">GetField</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">fieldName</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">++</span><span class="n">allFields</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span><span class="n">typecheck</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span><span class="n">env</span><span class="o">,</span><span class="n">e</span><span class="o">))).</span><span class="n">get</span><span class="o">(</span><span class="n">fieldName</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">c</span>
    <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;field &quot;</span><span class="o">+</span><span class="n">fieldName</span><span class="o">+</span><span class="s">&quot; does not exist&quot;</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="k">case</span> <span class="nc">MethodCall</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">methodName</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">rect</span> <span class="k">=</span> <span class="n">typecheck</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span> <span class="n">env</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">argt</span> <span class="k">=</span> <span class="n">args</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">typecheck</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span><span class="n">env</span><span class="o">,</span><span class="k">_</span><span class="o">))</span>
    <span class="n">classes</span><span class="o">(</span><span class="n">rect</span><span class="o">).</span><span class="n">methods</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">methodName</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">methodDecl</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">methodDecl</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">length</span> <span class="o">!=</span> <span class="n">args</span><span class="o">.</span><span class="n">length</span><span class="o">)</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;wrong number of arguments in call to &quot;</span><span class="o">+</span><span class="n">methodName</span><span class="o">)</span>
        <span class="n">argt</span><span class="o">.</span><span class="n">zip</span><span class="o">(</span><span class="n">methodDecl</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_2</span><span class="o">)).</span><span class="n">foreach</span><span class="o">(</span>
          <span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="o">(</span><span class="kt">Symbol</span><span class="o">,</span><span class="kt">Symbol</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="o">(!</span> <span class="n">subtype</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="n">_1</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="n">_2</span><span class="o">))</span> 
             <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;Actual arg type &quot;</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">_1</span><span class="o">+</span><span class="s">&quot; is not a subtype of formal arg type &quot;</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">_2</span><span class="o">))</span>        
        <span class="n">methodDecl</span><span class="o">.</span><span class="n">retType</span>
      <span class="o">}</span>
      <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;unknown method: &quot;</span><span class="o">+</span><span class="n">methodName</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="k">def</span> <span class="n">checkClassExists</span><span class="o">(</span><span class="n">classes</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Symbol</span>,<span class="kt">Class</span><span class="o">],</span> <span class="n">className</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">((</span><span class="n">className</span> <span class="o">!=</span> <span class="-Symbol">&#39;Object</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(!</span><span class="n">classes</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">className</span><span class="o">)))</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;unknown class: &quot;</span><span class="o">+</span><span class="n">className</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">def</span> <span class="n">checkmethod</span><span class="o">(</span><span class="n">classes</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Symbol</span>,<span class="kt">Class</span><span class="o">],</span> <span class="n">className</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">,</span> <span class="n">method</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">,</span> <span class="n">md</span><span class="k">:</span> <span class="kt">MethodDecl</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
  <span class="n">checkClassExists</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span><span class="n">md</span><span class="o">.</span><span class="n">retType</span><span class="o">)</span>
  <span class="n">md</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">foreach</span><span class="o">((</span><span class="n">s</span><span class="k">:</span><span class="o">(</span><span class="kt">Symbol</span><span class="o">,</span><span class="kt">Symbol</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="n">checkClassExists</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="n">_2</span><span class="o">))</span>
  <span class="n">lookupMethod</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span> <span class="n">classes</span><span class="o">(</span><span class="n">className</span><span class="o">).</span><span class="n">superClass</span><span class="o">,</span> <span class="n">method</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">smd</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="o">((</span><span class="n">smd</span><span class="o">.</span><span class="n">retType</span> <span class="o">!=</span> <span class="n">md</span><span class="o">.</span><span class="n">retType</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">smd</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span> <span class="o">!=</span> <span class="n">md</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_2</span><span class="o">)))</span> 
      <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;Invalid overriding of method: &quot;</span><span class="o">+</span><span class="n">method</span><span class="o">+</span> <span class="s">&quot; in class : &quot;</span><span class="o">+</span><span class="n">className</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="o">()</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">subtype</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span><span class="n">typecheck</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span> <span class="nc">Map</span><span class="o">(</span><span class="-Symbol">&#39;this</span> <span class="o">-&gt;</span> <span class="n">className</span><span class="o">)++</span><span class="n">md</span><span class="o">.</span><span class="n">args</span><span class="o">,</span> <span class="n">md</span><span class="o">.</span><span class="n">body</span><span class="o">),</span> <span class="n">md</span><span class="o">.</span><span class="n">retType</span><span class="o">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;Type of method body for method: &quot;</span><span class="o">+</span><span class="n">method</span><span class="o">+</span><span class="s">&quot; is not subtype of &quot;</span><span class="o">+</span><span class="n">md</span><span class="o">.</span><span class="n">retType</span><span class="o">+</span><span class="s">&quot; in class: &quot;</span><span class="o">+</span><span class="n">className</span><span class="o">)</span>
  
<span class="o">}</span>
<span class="k">def</span> <span class="n">checkclass</span><span class="o">(</span><span class="n">classes</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Symbol</span>,<span class="kt">Class</span><span class="o">],</span> <span class="n">className</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">,</span> <span class="n">cd</span><span class="k">:</span> <span class="kt">Class</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
  <span class="n">checkClassExists</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span> <span class="n">cd</span><span class="o">.</span><span class="n">superClass</span><span class="o">)</span>
  <span class="n">cd</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">foreach</span><span class="o">((</span><span class="n">s</span><span class="k">:</span> <span class="o">(</span><span class="kt">Symbol</span><span class="o">,</span><span class="kt">Symbol</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="n">checkClassExists</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span><span class="n">s</span><span class="o">.</span><span class="n">_2</span><span class="o">))</span>
  <span class="n">cd</span><span class="o">.</span><span class="n">methods</span><span class="o">.</span><span class="n">foreach</span><span class="o">((</span><span class="n">m</span><span class="k">:</span><span class="o">(</span><span class="kt">Symbol</span><span class="o">,</span> <span class="kt">MethodDecl</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="n">checkmethod</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span> <span class="n">className</span><span class="o">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_1</span><span class="o">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_2</span><span class="o">))</span>
  
<span class="o">}</span>
<span class="k">def</span> <span class="n">checkprog</span><span class="o">(</span><span class="n">classes</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Symbol</span>,<span class="kt">Class</span><span class="o">])</span>  <span class="k">=</span> <span class="n">classes</span><span class="o">.</span><span class="n">foreach</span><span class="o">((</span><span class="n">s</span><span class="k">:</span> <span class="o">(</span><span class="kt">Symbol</span><span class="o">,</span><span class="kt">Class</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="n">checkclass</span><span class="o">(</span><span class="n">classes</span><span class="o">,</span><span class="n">s</span><span class="o">.</span><span class="n">_1</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="n">_2</span><span class="o">))</span>
   
<span class="k">val</span> <span class="n">testclasses</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span>
  <span class="-Symbol">&#39;Bool</span> <span class="o">-&gt;</span> <span class="nc">Class</span><span class="o">(</span><span class="-Symbol">&#39;Object</span><span class="o">,</span> <span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">,</span> <span class="nc">Map</span><span class="o">(</span>
     <span class="-Symbol">&#39;ifThenElse</span> <span class="o">-&gt;</span> <span class="nc">MethodDecl</span><span class="o">(</span> <span class="nc">List</span><span class="o">((</span><span class="-Symbol">&#39;thenExp</span><span class="o">,</span> <span class="-Symbol">&#39;Object</span><span class="o">),</span> <span class="o">(</span><span class="-Symbol">&#39;elseExp</span><span class="o">,</span> <span class="-Symbol">&#39;Object</span><span class="o">)),</span> <span class="nc">Id</span><span class="o">(</span><span class="-Symbol">&#39;thenExp</span><span class="o">),</span> <span class="-Symbol">&#39;Object</span><span class="o">),</span> <span class="c1">// dummy default implementation</span>
     <span class="-Symbol">&#39;and</span> <span class="o">-&gt;</span> <span class="nc">MethodDecl</span><span class="o">(</span><span class="nc">List</span><span class="o">((</span><span class="-Symbol">&#39;x</span><span class="o">,</span><span class="-Symbol">&#39;Bool</span><span class="o">)),</span> <span class="nc">Id</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">),</span> <span class="-Symbol">&#39;Bool</span><span class="o">))),</span>                                             <span class="c1">// dummy default implementation</span>
  <span class="-Symbol">&#39;True</span> <span class="o">-&gt;</span> <span class="nc">Class</span><span class="o">(</span><span class="-Symbol">&#39;Bool</span><span class="o">,</span> <span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">,</span> <span class="nc">Map</span><span class="o">(</span>
     <span class="-Symbol">&#39;ifThenElse</span> <span class="o">-&gt;</span> <span class="nc">MethodDecl</span><span class="o">(</span> <span class="nc">List</span><span class="o">((</span><span class="-Symbol">&#39;thenExp</span><span class="o">,</span> <span class="-Symbol">&#39;Object</span><span class="o">),</span> <span class="o">(</span><span class="-Symbol">&#39;elseExp</span><span class="o">,</span> <span class="-Symbol">&#39;Object</span><span class="o">)),</span> <span class="nc">Id</span><span class="o">(</span><span class="-Symbol">&#39;thenExp</span><span class="o">),</span> <span class="-Symbol">&#39;Object</span><span class="o">),</span>
     <span class="-Symbol">&#39;and</span> <span class="o">-&gt;</span> <span class="nc">MethodDecl</span><span class="o">(</span><span class="nc">List</span><span class="o">((</span><span class="-Symbol">&#39;x</span><span class="o">,</span><span class="-Symbol">&#39;Bool</span><span class="o">)),</span> <span class="nc">Id</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">),</span> <span class="-Symbol">&#39;Bool</span><span class="o">))),</span>
  <span class="-Symbol">&#39;False</span> <span class="o">-&gt;</span> <span class="nc">Class</span><span class="o">(</span><span class="-Symbol">&#39;Bool</span><span class="o">,</span> <span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">,</span> <span class="nc">Map</span><span class="o">(</span>
     <span class="-Symbol">&#39;ifThenElse</span> <span class="o">-&gt;</span> <span class="nc">MethodDecl</span><span class="o">(</span><span class="nc">List</span><span class="o">((</span><span class="-Symbol">&#39;thenExp</span><span class="o">,</span> <span class="-Symbol">&#39;Object</span><span class="o">),</span> <span class="o">(</span><span class="-Symbol">&#39;elseExp</span><span class="o">,</span> <span class="-Symbol">&#39;Object</span><span class="o">)),</span> <span class="nc">Id</span><span class="o">(</span><span class="-Symbol">&#39;elseExp</span><span class="o">),</span> <span class="-Symbol">&#39;Object</span><span class="o">),</span>
     <span class="-Symbol">&#39;and</span> <span class="o">-&gt;</span> <span class="nc">MethodDecl</span><span class="o">(</span><span class="nc">List</span><span class="o">((</span><span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="-Symbol">&#39;Bool</span><span class="o">)),</span> <span class="nc">Id</span><span class="o">(</span><span class="-Symbol">&#39;this</span><span class="o">),</span> <span class="-Symbol">&#39;Bool</span><span class="o">))),</span>
  <span class="-Symbol">&#39;Food</span> <span class="o">-&gt;</span> <span class="nc">Class</span><span class="o">(</span><span class="-Symbol">&#39;Object</span><span class="o">,</span> <span class="nc">List</span><span class="o">((</span><span class="-Symbol">&#39;organic</span><span class="o">,</span> <span class="-Symbol">&#39;Bool</span><span class="o">)),</span>  <span class="nc">Map</span><span class="o">(</span>
     <span class="-Symbol">&#39;tastesBetterThan</span> <span class="o">-&gt;</span> 
       <span class="nc">MethodDecl</span><span class="o">(</span><span class="nc">List</span><span class="o">((</span><span class="-Symbol">&#39;other</span><span class="o">,</span> <span class="-Symbol">&#39;Food</span><span class="o">)),</span> <span class="nc">GetField</span><span class="o">(</span><span class="nc">Id</span><span class="o">(</span><span class="-Symbol">&#39;this</span><span class="o">),</span> <span class="-Symbol">&#39;organic</span><span class="o">),</span> <span class="-Symbol">&#39;Bool</span><span class="o">))),</span>
  <span class="-Symbol">&#39;Pizza</span> <span class="o">-&gt;</span> <span class="nc">Class</span><span class="o">(</span><span class="-Symbol">&#39;Food</span><span class="o">,</span> <span class="nc">List</span><span class="o">((</span><span class="-Symbol">&#39;hasCheese</span><span class="o">,</span><span class="-Symbol">&#39;Bool</span><span class="o">)),</span> <span class="nc">Map</span><span class="o">(</span>
     <span class="-Symbol">&#39;tastesBetterThan</span> <span class="o">-&gt;</span> 
       <span class="nc">MethodDecl</span><span class="o">(</span><span class="nc">List</span><span class="o">((</span><span class="-Symbol">&#39;other</span><span class="o">,</span><span class="-Symbol">&#39;Food</span><span class="o">)),</span> <span class="nc">MethodCall</span><span class="o">(</span><span class="nc">GetField</span><span class="o">(</span><span class="nc">Id</span><span class="o">(</span><span class="-Symbol">&#39;this</span><span class="o">),</span> <span class="-Symbol">&#39;organic</span><span class="o">),</span> <span class="-Symbol">&#39;and</span><span class="o">,</span>        <span class="nc">List</span><span class="o">(</span><span class="nc">GetField</span><span class="o">(</span><span class="nc">Id</span><span class="o">(</span><span class="-Symbol">&#39;this</span><span class="o">),</span> <span class="-Symbol">&#39;hasCheese</span><span class="o">))),</span> <span class="-Symbol">&#39;Bool</span><span class="o">))))</span>

<span class="n">checkprog</span><span class="o">(</span><span class="n">testclasses</span><span class="o">)</span>
       
<span class="n">assert</span><span class="o">(</span> 
 <span class="n">eval</span><span class="o">(</span><span class="n">testclasses</span><span class="o">,</span>  
   <span class="nc">MethodCall</span><span class="o">(</span>
     <span class="nc">New</span><span class="o">(</span><span class="-Symbol">&#39;Pizza</span><span class="o">,</span> <span class="nc">List</span><span class="o">(</span><span class="nc">New</span><span class="o">(</span><span class="-Symbol">&#39;True</span><span class="o">,</span> <span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">),</span> <span class="nc">New</span><span class="o">(</span><span class="-Symbol">&#39;True</span><span class="o">,</span> <span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">))),</span>
     <span class="-Symbol">&#39;tastesBetterThan</span><span class="o">,</span>
     <span class="nc">List</span><span class="o">(</span><span class="nc">New</span><span class="o">(</span><span class="-Symbol">&#39;Food</span><span class="o">,</span> <span class="nc">List</span><span class="o">(</span><span class="nc">New</span><span class="o">(</span><span class="-Symbol">&#39;True</span><span class="o">,</span> <span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">))))))</span>
  <span class="o">==</span>
  <span class="nc">New</span><span class="o">(</span><span class="-Symbol">&#39;True</span><span class="o">,</span> <span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">))</span></pre></code></div>
    </section>
  </article>
</body>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>3-wae.scala</title>
  <link rel="stylesheet" href="../recources/style.css">
</head>
<body>
  <a href="https://github.com/klauso/PLT2012"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>
  <header>
  <nav>
    <ul>    
        <li><a href="10-gc.html">10-gc.scala</a></li>
        <li><a href="11-syntacticvsmeta.html">11-syntacticvsmeta.scala</a></li>
        <li><a href="12-churchencoding.html">12-churchencoding.scala</a></li>
        <li><a href="13-cpstransformation.html">13-cpstransformation.scala</a></li>
        <li><a href="14-cpstransformation2.html">14-cpstransformation2.scala</a></li>
        <li><a href="16-firstclasscontinuations.html">16-firstclasscontinuations.scala</a></li>
        <li><a href="17-defunctionalization.html">17-defunctionalization.scala</a></li>
        <li><a href="18-abstractmachines.html">18-abstractmachines.scala</a></li>
        <li><a href="2-ae.html">2-ae.scala</a></li>
        <li><a href="20-normalization.html">20-normalization.scala</a></li>
        <li><a href="21-OO.html">21-OO.scala</a></li>
        <li><a href="26-OO-typed.html">26-OO-typed.scala</a></li>
        <li><a href="3-wae.html">3-wae.scala</a></li>
        <li><a href="4-f1wae.html">4-f1wae.scala</a></li>
        <li><a href="5-fae.html">5-fae.scala</a></li>
        <li><a href="6-lcfae.html">6-lcfae.scala</a></li>
        <li><a href="8-rcfae.html">8-rcfae.scala</a></li>
        <li><a href="9-bcfae.html">9-bcfae.scala</a></li>
    </ul>
  </nav>
  </header>
  <article id="documentation">
    <section id='section-Adding_With-Expresions'>
      <div class="docs"><h1>Adding With-Expresions</h1>

<p>These are lecture notes for the &ldquo;Programming Languages and Types&rdquo; at the 
University of Marburg loosely based on Sec. 3 of the book &ldquo;Programming 
Languages: Application and Interpretation&rdquo; by Shriram Krishnamurthi.
Please send comments or errors in these notes via email to Klaus Ostermann.
My email address can be found on my webpage. Alternatively, you can also 
propose corrections as a github pull request.</p></div>
      <div class="code"><code class='highlight'><pre></pre></code></div>
    </section>
    <section id='section-2'>
      <div class="docs"><p>We want, step by step, to develop our primitive calculator language into a 
full-fledged PL. </p>

<p>One important milestone on this way is the ability to deal with names.
While our previous language allowed expressions with identifiers in them,
it had no <em>binders</em> : Constructs that allow to give meaning to a new name.</p>

<p>In this variant of the language, called WAE, we introduce such a binder
called <code>With</code> with which we can give an expression a name that can be used
in the body of the <code>With</code> expression. This intuition is captured in the 
definition of the <code>With</code> case class below, which extends our previous 
language. </p>

<p>We study this WAE language to better understand what names mean in 
programming languages, and how they can be implemented.</p>

<p>Note that we deal with <em>two</em> languages here:</p>

<ol>
<li>This Scala file with Scala code. (The so-called &ldquo;meta-language&rdquo;)</li>
<li>Most of the functions work on programs written in the WAE language. (Or
also called &ldquo;object-language&rdquo;)</li>
</ol>

<p>Most of the time, we concentrate on WAE, but sometimes, we also talk about 
Scala.</p>

<p>We have not defined a concrete syntax for WAE, but it is a real language 
nevertheless. We sometimes use some made-up syntax for examples on the 
blackboard or in comments.</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">sealed</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">Exp</span> 
<span class="k">case</span> <span class="k">class</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Exp</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Add</span><span class="o">(</span><span class="n">lhs</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">,</span> <span class="n">rhs</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Exp</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Mul</span><span class="o">(</span><span class="n">lhs</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">,</span> <span class="n">rhs</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Exp</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Id</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Exp</span> 
<span class="k">case</span> <span class="k">class</span> <span class="nc">With</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">,</span> <span class="n">xdef</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">,</span> <span class="n">body</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Exp</span>
 </pre></code></div>
    </section>
    <section id='section-3'>
      <div class="docs"><p>We use implicits again to make example programs less verbose.</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">implicit</span> <span class="k">def</span> <span class="n">num2exp</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n</span><span class="o">)</span>
<span class="k">implicit</span> <span class="k">def</span> <span class="n">sym2exp</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Symbol</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Id</span><span class="o">(</span><span class="n">x</span><span class="o">)</span></pre></code></div>
    </section>
    <section id='section-4'>
      <div class="docs"><p>A first example program in WAE.</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">val</span> <span class="n">test</span> <span class="k">=</span> <span class="nc">With</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="nc">Add</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">,</span><span class="-Symbol">&#39;x</span><span class="o">))</span></pre></code></div>
    </section>
    <section id='section-Substitution'>
      <div class="docs"><h2>Substitution</h2>

<p>Instead of dealing with identifiers as external entities as in AE, 
identifiers can now be defined within the language. This justifies a new 
treatment of identifiers. We will explain them in terms of <em>substitution</em>, 
a notion well-known informally from Gymnasium algebra.</p>

<p>The idea is the following: The interpreter transforms the term</p>

<pre><code>with (x = 5) {
  x + x
}
</code></pre>

<p>into</p>

<pre><code>5 + 5
</code></pre>

<p>before proceeding. That is, all occurrences of <code>x</code> have been replaced by 5.</p>

<p>Note that these two programs &mdash; before and after the substitution &mdash; are 
certainly not <em>equal</em>: They look quite different. However, they are 
<em>equivalent</em> in the sense that when evaluated, they will produce the same 
number. Such transformations between different but somehow equivalent 
programs are an important tool for the study of programs, and of programming 
languages.</p>

<p>Often, if we know which programs behave identically, we understand better how 
programs behave in general. We will see more examples of this in this 
lecture.</p>

<p>Hence, the implementation of the <code>With</code> case of our interpreter should be 
something like:</p>

<pre><code>case With(x, xdef, body) =&gt; eval(subst(body,x,Num(eval(xdef))))
</code></pre>

<p>utilizing a function <code>subst</code> with the following signature:</p>

<pre><code>subst: (Exp,Symbol,Num) =&gt; Exp
</code></pre>

<p>The type of the third parameter is <code>Num</code> instead of <code>Exp</code> because it is more 
difficult to get substitution correct when arbitrary expressions can be 
inserted (accidential name capture problem, more about that later).</p>

<p>Since we want to experiment with different versions of substitution, we write 
the interpreter in such a way that we can parameterize it with a 
substitution function:</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">def</span> <span class="n">makeEval</span><span class="o">(</span><span class="n">subst</span><span class="k">:</span> <span class="o">(</span><span class="kt">Exp</span><span class="o">,</span><span class="kt">Symbol</span><span class="o">,</span><span class="nc">Num</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Exp</span><span class="o">)</span><span class="k">:</span> <span class="kt">Exp</span> <span class="o">=&gt;</span> <span class="nc">Int</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">Exp</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="n">e</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">n</span>
    <span class="k">case</span> <span class="nc">Id</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;unbound variable: &quot;</span><span class="o">+</span><span class="n">x</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">Add</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">eval</span><span class="o">(</span><span class="n">l</span><span class="o">)</span> <span class="o">+</span> <span class="n">eval</span><span class="o">(</span><span class="n">r</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">Mul</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">eval</span><span class="o">(</span><span class="n">l</span><span class="o">)</span> <span class="o">*</span> <span class="n">eval</span><span class="o">(</span><span class="n">r</span><span class="o">)</span>

    <span class="c1">// After evaluation, take the `Int` and wrap it into a `Num`:</span>
    <span class="k">case</span> <span class="nc">With</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">xdef</span><span class="o">,</span> <span class="n">body</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">eval</span><span class="o">(</span><span class="n">subst</span><span class="o">(</span><span class="n">body</span><span class="o">,</span><span class="n">x</span><span class="o">,</span><span class="nc">Num</span><span class="o">(</span><span class="n">eval</span><span class="o">(</span><span class="n">xdef</span><span class="o">))))</span> 
  <span class="o">}</span>
  <span class="n">eval</span>
<span class="o">}</span></pre></code></div>
    </section>
    <section id='section-6'>
      <div class="docs"><blockquote>
<p><strong>Definition (Substitution &ndash; Take 1):</strong>
To substitute identiﬁer <code>i</code> in <code>e</code> with expression <code>v</code>, replace all 
identiﬁers in <code>e</code> that have the name <code>i</code> with the expression <code>v</code>.</p>
</blockquote>
<p>Let&rsquo;s try to formalize this definition:</p></div>
      <div class="code"><code class='highlight'><pre><span class="c1">// val subst1 : (Exp,Symbol,Num) =&gt; Exp = (e,i,v) =&gt; e match {</span>
<span class="c1">//   case Num(n) =&gt; e</span>
<span class="c1">//   case Id(x) =&gt; if (x == i) v else e</span>
<span class="c1">//   case Add(l,r) =&gt; Add( subst1(l,i,v), subst1(r,i,v))</span>
<span class="c1">//   case Mul(l,r) =&gt; Mul( subst1(l,i,v), subst1(r,i,v))</span>
<span class="c1">//   case With(x,xdef,body) =&gt; With( if (x ==i) v else x,</span>
<span class="c1">//                                   subst1(xdef,i,v),</span>
<span class="c1">//                                   subst1(body,i,v))</span>
<span class="c1">// }</span></pre></code></div>
    </section>
    <section id='section-7'>
      <div class="docs"><p>Unfortunately this does not even type-check! And rightly so, because it might 
otherwise turn reasonable programs into programs that are not even 
syntactically legal anymore.</p>

<p>Exercise for self-study: Find an expression that would be transformed into 
one that is not syntactically legal.</p>

<p>To see the reason for this, we need to define some terminology (the word 
&ldquo;instance&rdquo; here means &ldquo;occurence&rdquo;):</p>
<blockquote>
<p><strong>Deﬁnition (Binding Instance):</strong>
A <em>binding instance</em> of an identiﬁer is the instance of the identiﬁer that 
gives it its value. In WAE , the <code>x</code> position of a with is the only binding 
instance.</p>

<p><strong>Deﬁnition (Scope):</strong>
The <em>scope</em> of a binding instance is the region of program text in which 
instances of the identiﬁer refer to the value bound by the binding instance.</p>

<p><strong>Deﬁnition (Bound Instance):</strong>
An identiﬁer is <em>bound</em> if it is contained within the scope of a binding 
instance of its name.</p>

<p><strong>Deﬁnition (Free Instance):</strong>
An identiﬁer not contained in the scope of any binding instance of its name 
is said to be <em>free</em>.</p>
</blockquote>
<p>Examples: In WAE, the symbol in <code>Id(&lsquo;x)</code> is a bound or free instance, and the
symbol in <code>With('x, …, …)</code> is a binding instance. The scope of this binding 
instance is the third sub-term of <code>With</code>.</p>

<p>Now the reason can be revealed. Our first attempt failed because we substitue 
the identifier occurs in the binding position in the with-expression. This 
renders the expression because after substitution illegal the binding 
position is occupied by a <code>Num</code> but an identifier is expected.</p>

<p>To correct this mistake, we need another take at defining substitution:</p>
<blockquote>
<p><strong>Definition (Substitution &ndash; Take 2):</strong>
To substitute identiﬁer <code>i</code> in <code>e</code> with expression <code>v</code>, replace all 
identifiers in <code>e</code> which are not binding instances that have the name <code>i</code>
 with the expression <code>v</code>.</p>
</blockquote>
<p>Here is the formalization of this second definition:</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">val</span> <span class="n">subst2</span><span class="k">:</span> <span class="o">(</span><span class="kt">Exp</span><span class="o">,</span><span class="kt">Symbol</span><span class="o">,</span><span class="nc">Num</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Exp</span> <span class="k">=</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">e</span> <span class="k">match</span> <span class="o">{</span>

    <span class="k">case</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">e</span>
    
    <span class="c1">// Bound or free instance =&gt; substitute if names match</span>
    <span class="k">case</span> <span class="nc">Id</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">i</span><span class="o">)</span> <span class="n">v</span> <span class="k">else</span> <span class="n">e</span>
    
    <span class="k">case</span> <span class="nc">Add</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Add</span><span class="o">(</span> <span class="n">subst2</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">),</span> <span class="n">subst2</span><span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">))</span>
    <span class="k">case</span> <span class="nc">Mul</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Mul</span><span class="o">(</span> <span class="n">subst2</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">),</span> <span class="n">subst2</span><span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">))</span>
    
    <span class="c1">// Binding instance =&gt; do not substitute</span>
    <span class="k">case</span> <span class="nc">With</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">xdef</span><span class="o">,</span><span class="n">body</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">With</span><span class="o">(</span> <span class="n">x</span><span class="o">,</span>
                                    <span class="n">subst2</span><span class="o">(</span><span class="n">xdef</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">),</span>
                                    <span class="n">subst2</span><span class="o">(</span><span class="n">body</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">))</span>
<span class="o">}</span></pre></code></div>
    </section>
    <section id='section-8'>
      <div class="docs"><p>Let&rsquo;s create an interpreter that uses this substitution function.</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">def</span> <span class="n">eval2</span> <span class="k">=</span> <span class="n">makeEval</span><span class="o">(</span><span class="n">subst2</span><span class="o">)</span>

<span class="n">assert</span><span class="o">(</span><span class="n">eval2</span><span class="o">(</span><span class="n">test</span><span class="o">)</span> <span class="o">==</span> <span class="mi">10</span><span class="o">)</span> <span class="c1">//=&gt; it works!</span>

<span class="k">val</span> <span class="n">test2</span> <span class="k">=</span> <span class="nc">With</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="nc">Add</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="nc">With</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span><span class="mi">10</span><span class="o">)))</span>

<span class="n">assert</span><span class="o">(</span><span class="n">eval2</span><span class="o">(</span><span class="n">test2</span><span class="o">)</span> <span class="o">==</span> <span class="mi">15</span><span class="o">)</span> <span class="c1">//=&gt; also works as expected</span>

<span class="k">val</span> <span class="n">test3</span> <span class="k">=</span> <span class="nc">With</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="nc">Add</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="nc">With</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span><span class="-Symbol">&#39;x</span><span class="o">)))</span>

<span class="c1">// assert(eval2(test3) == 8) //=&gt; Bang! Result is 10 instead!</span></pre></code></div>
    </section>
    <section id='section-9'>
      <div class="docs"><p>What went wrong here? Our substitution algorithm respected binding instances, 
but not their scope.
In the sample expression, the with introduces a new scope for the inner <code>x</code>. 
The scope of the outer <code>x</code> is <em>shadowed</em> or <em>masked</em> by the inner binding. 
Because substitution doesn’t recognize this possibility, it incorrectly 
substitutes the inner <code>x</code>. </p>
<blockquote>
<p><strong>Definition (Substitution &ndash; Take 3):</strong>
To substitute identiﬁer <code>i</code> in <code>e</code> with expression <code>v</code>, replace all non-
binding identiﬁers in <code>e</code> having the name <code>i</code> with the expression <code>v</code>, 
unless the identiﬁer is in a scope different from that introduced by <code>i</code>. </p>
</blockquote>
<p>So, what happens if we just forget to substitute into the body?</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">val</span> <span class="n">subst3</span><span class="k">:</span> <span class="o">(</span><span class="kt">Exp</span><span class="o">,</span><span class="kt">Symbol</span><span class="o">,</span><span class="nc">Num</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Exp</span> <span class="k">=</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">e</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">e</span>
    <span class="k">case</span> <span class="nc">Id</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">i</span><span class="o">)</span> <span class="n">v</span> <span class="k">else</span> <span class="n">e</span>
    <span class="k">case</span> <span class="nc">Add</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Add</span><span class="o">(</span> <span class="n">subst3</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">),</span> <span class="n">subst3</span><span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">))</span>
    <span class="k">case</span> <span class="nc">Mul</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Mul</span><span class="o">(</span> <span class="n">subst3</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">),</span> <span class="n">subst3</span><span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">))</span>

    <span class="c1">// Here `body` is not substituted recursively:</span>
    <span class="k">case</span> <span class="nc">With</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">xdef</span><span class="o">,</span><span class="n">body</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">With</span><span class="o">(</span> <span class="n">x</span><span class="o">,</span> 
                                    <span class="n">subst3</span><span class="o">(</span><span class="n">xdef</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">),</span> 
                                    <span class="n">body</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">eval3</span> <span class="k">=</span> <span class="n">makeEval</span><span class="o">(</span><span class="n">subst3</span><span class="o">)</span>

<span class="n">assert</span><span class="o">(</span><span class="n">eval3</span><span class="o">(</span><span class="n">test</span><span class="o">)</span> <span class="o">==</span> <span class="mi">10</span><span class="o">)</span>

<span class="n">assert</span><span class="o">(</span><span class="n">eval3</span><span class="o">(</span><span class="n">test2</span><span class="o">)</span> <span class="o">==</span> <span class="mi">15</span><span class="o">)</span>

<span class="n">assert</span><span class="o">(</span><span class="n">eval3</span><span class="o">(</span><span class="n">test3</span><span class="o">)</span> <span class="o">==</span> <span class="mi">8</span><span class="o">)</span> <span class="c1">//=&gt; Now test3 works!</span></pre></code></div>
    </section>
    <section id='section-10'>
      <div class="docs"><p>Adding another test, we see that this sadly is no true solution:</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">val</span> <span class="n">test4</span> <span class="k">=</span> <span class="nc">With</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="nc">Add</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="nc">With</span><span class="o">(</span><span class="-Symbol">&#39;y</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span><span class="-Symbol">&#39;x</span><span class="o">)))</span>

<span class="c1">// assert(eval3(test4) == 10) //=&gt; Bang! unbound variable: &#39;x</span></pre></code></div>
    </section>
    <section id='section-11'>
      <div class="docs"><p>The inner expression should result in an error, because <code>x</code> has no value. 
Once again, substitution has changed a correct program into an incorrect one!</p>

<p>Let’s understand what went wrong. Why didn’t we substitute the inner <code>x</code>? 
Substitution halts at the <code>With</code> since, by deﬁnition, every <code>With</code> introduces 
a new scope, which we said should delimit further substitution. </p>

<p>But in this example <code>With</code> contains an instance of <code>x</code>, which we very much 
want to be substituted! So the question is, shall we substitute within nested 
scopes or not? Actually, the two examples above should reveal that our latest
deﬁnition for substitution, which may have seemed sensible at ﬁrst blush, 
is too draconian: it rules out substitution within <em>any</em> nested scopes.</p>
<blockquote>
<p><strong>Definition (Substitution &ndash; Take 4):</strong>
To substitute identiﬁer <code>i</code> in <code>e</code> with expression <code>v</code>, replace all non-
binding identiﬁers in <code>e</code> having the name <code>i</code> with the expression <code>v</code>, 
except within nested scopes of <code>i</code>.</p>
</blockquote>
<p>Finally, we have a version of substitution that works. A different, more 
succint way of phrasing this deﬁnition:</p>
<blockquote>
<p><strong>Deﬁnition (Substitution &ndash; Final Take):</strong>
To substitute identiﬁer <code>i</code> in <code>e</code> with expression <code>v</code>, replace all free 
instances of <code>i</code> in <code>e</code> with <code>v</code>.</p>
</blockquote>
<p>A first attempt to implement this definition:</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">val</span> <span class="n">subst4</span><span class="k">:</span> <span class="o">(</span><span class="kt">Exp</span><span class="o">,</span><span class="kt">Symbol</span><span class="o">,</span><span class="nc">Num</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Exp</span> <span class="k">=</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">e</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">e</span>
    <span class="k">case</span> <span class="nc">Id</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">i</span><span class="o">)</span> <span class="n">v</span> <span class="k">else</span> <span class="n">e</span>
    <span class="k">case</span> <span class="nc">Add</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Add</span><span class="o">(</span> <span class="n">subst4</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">),</span> <span class="n">subst4</span><span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">))</span>
    <span class="k">case</span> <span class="nc">Mul</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Mul</span><span class="o">(</span> <span class="n">subst4</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">),</span> <span class="n">subst4</span><span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">))</span>

    <span class="c1">// Do not substitute when shadowed!</span>
    <span class="k">case</span> <span class="nc">With</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">xdef</span><span class="o">,</span><span class="n">body</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">i</span><span class="o">)</span> <span class="n">e</span> 
                              <span class="k">else</span> <span class="nc">With</span><span class="o">(</span> <span class="n">x</span><span class="o">,</span>
                                         <span class="n">subst4</span><span class="o">(</span><span class="n">xdef</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">),</span>
                                         <span class="n">subst4</span><span class="o">(</span><span class="n">body</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">))</span>
<span class="o">}</span>
 
<span class="k">def</span> <span class="n">eval4</span> <span class="k">=</span> <span class="n">makeEval</span><span class="o">(</span><span class="n">subst4</span><span class="o">)</span>

<span class="n">assert</span><span class="o">(</span><span class="n">eval4</span><span class="o">(</span><span class="n">test</span><span class="o">)</span> <span class="o">==</span> <span class="mi">10</span><span class="o">)</span>

<span class="n">assert</span><span class="o">(</span><span class="n">eval4</span><span class="o">(</span><span class="n">test2</span><span class="o">)</span> <span class="o">==</span> <span class="mi">15</span><span class="o">)</span>

<span class="n">assert</span><span class="o">(</span><span class="n">eval4</span><span class="o">(</span><span class="n">test3</span><span class="o">)</span> <span class="o">==</span> <span class="mi">8</span><span class="o">)</span> 

<span class="n">assert</span><span class="o">(</span><span class="n">eval4</span><span class="o">(</span><span class="n">test4</span><span class="o">)</span> <span class="o">==</span> <span class="mi">10</span><span class="o">)</span> <span class="c1">//=&gt; Success!</span>

<span class="k">val</span> <span class="n">test5</span> <span class="k">=</span> <span class="nc">With</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="nc">With</span><span class="o">(</span><span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="-Symbol">&#39;x</span><span class="o">,</span> <span class="-Symbol">&#39;x</span><span class="o">))</span>

<span class="c1">// assert(eval4(test5) == 5) //=&gt; Bang! unbound variable &#39;x</span></pre></code></div>
    </section>
    <section id='section-12'>
      <div class="docs"><p>This program should evaluate to 5, but it too halts with an error. This is 
because we prematurely stopped substituting for <code>x</code> occuring in a bound 
position. We should substitute in the named expression of a <code>With</code> even if 
the <code>With</code> in question deﬁnes a new scope for the identiﬁer being substituted, 
because its named expression is still in the scope of the enclosing binding 
of the identiﬁer.  </p>

<p>We ﬁnally get a valid programmatic deﬁnition of substitution (relative to the 
language we have so far):</p></div>
      <div class="code"><code class='highlight'><pre><span class="k">val</span> <span class="n">subst5</span><span class="k">:</span> <span class="o">(</span><span class="kt">Exp</span><span class="o">,</span><span class="kt">Symbol</span><span class="o">,</span><span class="nc">Num</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Exp</span> <span class="k">=</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">e</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Num</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">e</span>
    <span class="k">case</span> <span class="nc">Id</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">i</span><span class="o">)</span> <span class="n">v</span> <span class="k">else</span> <span class="n">e</span>
    <span class="k">case</span> <span class="nc">Add</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Add</span><span class="o">(</span> <span class="n">subst5</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">),</span> <span class="n">subst5</span><span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">))</span>
    <span class="k">case</span> <span class="nc">Mul</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Mul</span><span class="o">(</span> <span class="n">subst5</span><span class="o">(</span><span class="n">l</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">),</span> <span class="n">subst5</span><span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">))</span>

    <span class="c1">// Handle shadowing inside of `body`, not in `xdef`</span>
    <span class="k">case</span> <span class="nc">With</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">xdef</span><span class="o">,</span><span class="n">body</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">With</span><span class="o">(</span> <span class="n">x</span><span class="o">,</span>
                                    <span class="n">subst5</span><span class="o">(</span><span class="n">xdef</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">),</span>
                                    <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">i</span><span class="o">)</span> <span class="n">body</span> <span class="k">else</span> <span class="n">subst5</span><span class="o">(</span><span class="n">body</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">v</span><span class="o">))</span>
<span class="o">}</span>
 
<span class="k">def</span> <span class="n">eval5</span> <span class="k">=</span> <span class="n">makeEval</span><span class="o">(</span><span class="n">subst5</span><span class="o">)</span>

<span class="n">assert</span><span class="o">(</span><span class="n">eval5</span><span class="o">(</span><span class="n">test</span><span class="o">)</span> <span class="o">==</span> <span class="mi">10</span><span class="o">)</span>

<span class="n">assert</span><span class="o">(</span><span class="n">eval5</span><span class="o">(</span><span class="n">test2</span><span class="o">)</span> <span class="o">==</span> <span class="mi">15</span><span class="o">)</span>

<span class="n">assert</span><span class="o">(</span><span class="n">eval5</span><span class="o">(</span><span class="n">test3</span><span class="o">)</span> <span class="o">==</span> <span class="mi">8</span><span class="o">)</span> 

<span class="n">assert</span><span class="o">(</span><span class="n">eval5</span><span class="o">(</span><span class="n">test4</span><span class="o">)</span> <span class="o">==</span> <span class="mi">10</span><span class="o">)</span> 

<span class="n">assert</span><span class="o">(</span><span class="n">eval5</span><span class="o">(</span><span class="n">test5</span><span class="o">)</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>  <span class="o">*=&gt;</span> <span class="nc">Success</span><span class="o">!</span>

 
 </pre></code></div>
    </section>
    <section id='section-Summary'>
      <div class="docs"><h2>Summary</h2>

<p>In this section we tried to introduce binding of names to our WAE language. 
Doing so we have learned that</p>

<ol>
<li><p>Substitution can be used to understand the meaning of names in 
programming languages.</p></li>
<li><p>Correct implementations of substitution need to handle free, bound, 
and binding instances of names and their scopes correctly. </p></li>
</ol>
</div>
      <div class="code"><code class='highlight'><pre></pre></code></div>
    </section>
  </article>
</body>
